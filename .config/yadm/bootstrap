#/bin/bash

gh_email=${gh_email:-ishaat@ualberta.ca}
gh_username=${gh_username:-ishchow}
gh_key_name=${gh_key_name:-$HOSTNAME}
gh_access_token_name=${gh_access_token_name:-access-token-jeos-setup-script}
yadm_class=${yadm_class:-Personal} # Set to Work for work profile

# parse args
# taken from: https://brianchildress.co/named-parameters-in-bash/
while [ $# -gt 0 ]; do
    if [[ $1 == *"--"* ]]; then
        param="${1/--/}"
        declare $param="$2"
        # echo $1 $2 // Optional to see the parameter:value result
    fi
    shift
done

echo "Updating system..."
sudo zypper ref && sudo zypper dup -y

echo "Installing core packages..."
sudo zypper in -y -t pattern devel_basis
sudo zypper in -y \
    wget \
    tree \
    curl \
    jq \
    fuse \
    ripgrep \
    ripgrep-bash-completion \
    bat \
    nodejs-default \
    npm \
    yarn \
    exa \
    ruby \
    python \
    python2-pip \
    python3 \
    python3-pip \
    python3-virtualenvwrapper \
    git \
    gpg2 \
    hub \
    tig \
    tmux \
    fzf \
    fzf-bash-completion \
    fzf-tmux \
    clang \
    lldb

echo "Installing global node packages"
sudo npm install -g \
    @bitwarden/cli \
    vim-language-server \
    vscode-json-languageserver \
    bash-language-server \
    vscode-html-languageserver-bin \
    pyright

echo "Installing global python packages"
sudo pip3 install \
    pynvim \
    neovim-remote \
    debugpy

if [[ $(find ~/.ssh -name "id*" | wc -l) -eq 0 ]]; then
    echo "Generating ssh key..."
    ssh-keygen -t ed25519 -C "$gh_email" -f ~/.ssh/id_ed25519 -N ""

    echo "Logging into bitwarden..."
    session_id=$(bw login --raw)

    echo "Getting GitHub access token..."
    access_token=$(bw list items --search github --session $session_id \
        | jq --arg ghuser "$gh_username" 'map(select(.object == "item" and .login.username == $ghuser))[0]' \
        | jq --arg atn "$gh_access_token_name" '.fields | map(select(.name == $atn))[0].value' \
        | sed 's/"//g')
        
    echo "Uploading ssh key..."
    pubkey=$(cat ~/.ssh/id_ed25519.pub)
    payload=$(jq --indent 0 -n --arg pubkey "$pubkey" --arg title "$gh_key_name" '{title: $title, key: $pubkey}')
    status_code=$(curl -s -o /dev/null -L -w "%{http_code}\\n" -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $access_token" -d "$payload" https://api.github.com/user/keys)
    echo "Upload of ssh key completed with status code $status_code..."

    echo "Logging out of bitwarden..."
    bw logout

    echo "Adding key to ssh config..."
    printf 'Host *\n\tIdentityFile ~/.ssh/id_ed25519\n' >> config
fi

if ! command -v yadm &> /dev/null; then
    echo "Installing yadm..."
    sudo zypper ar https://download.opensuse.org/repositories/home:TheLocehiliosan:yadm/openSUSE_Tumbleweed/home:TheLocehiliosan:yadm.repo
    sudo zypper --gpg-auto-import-keys ref
    sudo zypper in -y yadm
    
    echo "Cloning dotfiles..."
    yadm clone git@github.com:ishchow/dotfiles.git --no-bootstrap
    if [ ! $? -eq 0 ]; then
        yadm clone https://github.com/ishchow/dotfiles.git --no-bootstrap
    fi
    
    echo "Setting yadm class..."
    yadm config local.class $yadm_class
fi

if ! command -v nvim &> /dev/null; then
    echo "Installing neovim from source..."
    sudo zypper in -y ninja libtool autoconf automake cmake gcc-c++ gettext-tools
    git clone https://github.com/neovim/neovim.git ~/.nvim
    make CMAKE_BUILD_TYPE=RelWithDebInfo -C ~/.nvim
    sudo make -C ~/.nvim install
fi

if [ ! -d ~/.tmux/plugins/tpm ]; then
    echo "Installing tmux plugin manager (tpm)..."
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

if ! command -v fff &> /dev/null; then
    echo "Installing fast file finder (fff)..."
    git clone https://github.com/dylanaraps/fff ~/.fff
    sudo make -C ~/.fff install
fi

if ! command -v lazygit &> /dev/null; then
    echo "Installing lazygit..."
    sudo zypper ar https://download.opensuse.org/repositories/home:Dead_Mozay/openSUSE_Tumbleweed/home:Dead_Mozay.repo
    sudo zypper --gpg-auto-import-keys ref
    sudo zypper in -y lazygit
fi

if [ ! -d ~/projects ]; then
    echo "Creating projects folder..."
    mkdir -p ~/projects
fi

if [ ! -d ~/.git-sync ]; then
    echo "Downloading git-sync..."
    git clone https://github.com/simonthum/git-sync.git ~/.git-sync
fi

if [ ! -d ~/wikis/default ]; then
    echo "Cloning personal wikis..."
    if git clone git@github.com:ishchow/wikis.git ~/wikis/default ; then
        echo "Starting systemd services/timers for personal wikis..."
        systemctl --user --now enable git-sync@$(systemd-escape "$HOME/wikis/default").service
        systemctl --user --now enable git-sync@$(systemd-escape "$HOME/wikis/default").timer
    fi
fi

if ! command -v nmblookup &> /dev/null; then
    echo "Setting up Samba..."
    sudo zypper in -y samba samba-client samba-winbind
    sudo systemctl disable --now firewalld 
    sudo systemctl enable --now nmb
    sudo systemctl enable --now winbind
fi
